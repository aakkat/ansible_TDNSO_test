- name: Create NSO admin group
  group:
    name: ncsadmin
    state: present
  become: true

- name: Adding to the ncsadmin group
  user:
    name: "{{ ansible_user }}" 
    groups: ncsadmin
    append: yes
  become: true

- name: Download NSO install file (Remote copy)
  get_url:
    url: "{{ NSOImageLocation }}" 
    dest: /tmp/NSO.bin
    mode: '640'
  when: NSOCopyType == 'remote'

- name: Copy NSO install file (Local copy)
  copy:
    src: "{{ NSOImageLocation }}" 
    dest: /tmp/NSO.bin
    mode: '740'
  become: true
  when: NSOCopyType == 'local'

- name: Unpack NSO install file
  shell: sh /tmp/NSO.bin > /tmp/aNSOble.log
  args:
    chdir: /tmp/
  become: true

- name: Perfom NSO system install
  shell: eval "/tmp/$(sed -e s/\ /\\n/g aNSOble.log | grep bin | tail -1) --system-install --non-interactive" >> /tmp/aNSOble.log
  args:
    chdir: /tmp/
  become: true

- name: Start NSO service
  shell: |
    source /etc/profile.d/ncs.sh
    /etc/init.d/ncs start >> /tmp/aNSOble.log
  become: true

- name: Creating the default authgroup file from template
  template:
    src: authgroup.j2 
    dest: /home/{{ ansible_user }}/authgroup.xml

- name: Load default authgroup
  shell: ncs_load -l -m authgroup.xml
  environment:
    PATH: /opt/ncs/current/bin:{{ ansible_env.PATH }}

