- name: Cloning the repository to /tmp directory
  git:
    repo: "https://{{GITUser}}:{{GITKeyPass}}@{{RepositoryURL}}"
    dest: /tmp/repo
    version: "{{ RepositoryBranch }}"
    force: yes

- name: Copy NSO service packages to /var/opt/ncs/packages
  shell: "cp -r repo/{{ ServicePackagesPath }}/{{ item.name }}/ /var/opt/ncs/packages/"
  args:
    chdir: /tmp/
    warn: false
  become: true
  loop: "{{ Packages }}"

- name: Compiling the packages 
  shell: make clean all -C {{ item.name }}/src/
  args:
    chdir: /var/opt/ncs/packages/
    warn: false
  become: true
  when: item.needsCompiling 
  loop: "{{ Packages }}"

- name: Reloading NSO packages
  shell: |
    source /opt/ncs/current/ncsrc
    echo 'packages reload' | ncs_cli -C
  environment:
    PATH: /opt/ncs/current/bin:{{ ansible_env.PATH }}  
